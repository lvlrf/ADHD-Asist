
{% extends "base.html" %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-white flex items-center gap-2">
        <i data-lucide="clipboard-list" class="text-orange-400"></i> مدیریت کارها
    </h1>
    <button class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
        <i data-lucide="plus"></i> کار جدید
    </button>
</div>

<!-- Filters (Visual Only) -->
<div class="flex gap-4 mb-6 text-sm text-slate-400">
    <div class="flex-1 bg-slate-800/50 p-2 rounded border border-white/5 flex justify-between items-center">
        <span>تحویل پروژه</span>
        <i data-lucide="check-square" class="text-green-500"></i>
    </div>
    <div class="flex-1 bg-slate-800/50 p-2 rounded border border-white/5 flex justify-between items-center">
        <span>انجام پروژه</span>
        <i data-lucide="activity" class="text-yellow-500"></i>
    </div>
    <div class="flex-1 bg-slate-800/50 p-2 rounded border border-white/5 flex justify-between items-center">
        <span>پیگیری‌ها</span>
        <i data-lucide="phone" class="text-pink-500"></i>
    </div>
</div>

<div class="flex gap-4 overflow-x-auto pb-4 h-[calc(100vh-200px)]">
    {% set columns = {'Inbox': 'ورودی', 'Next Action': 'کار بعدی', 'In Progress': 'در حال انجام', 'Done': 'انجام شده'} %}
    
    {% for status_key, status_label in columns.items() %}
    <div class="w-80 flex-shrink-0 flex flex-col">
        <div class="bg-slate-800/60 p-3 rounded-t-xl border-b-2 border-white/10 flex justify-between items-center">
            <h3 class="font-bold text-slate-200">{{ status_label }}</h3>
            <span class="text-xs bg-slate-700 px-2 py-0.5 rounded-full text-slate-300">
                {{ tasks | selectattr('status', 'equalto', status_key) | list | length }}
            </span>
        </div>
        
        <div class="flex-1 bg-slate-900/30 border border-white/5 rounded-b-xl p-3 overflow-y-auto kanban-col" data-status="{{ status_key }}">
            {% for task in tasks if task.status == status_key %}
            <div class="bg-slate-800 p-3 rounded-lg mb-3 border border-white/5 hover:border-blue-500/50 cursor-grab task-card group" data-id="{{ task.id }}">
                <div class="flex justify-between items-start mb-2">
                    <h4 class="{{ 'line-through text-slate-500' if task.status == 'Done' else 'text-white' }} text-sm font-medium">{{ task.title }}</h4>
                    {% if 'High Focus' in task.energy|string %}
                    <i data-lucide="zap" size="14" class="text-orange-500"></i>
                    {% endif %}
                </div>
                
                <div class="flex flex-wrap gap-1 mt-2">
                    {% if task.context %}
                        {% for c in task.context %}
                        <span class="text-[10px] bg-slate-700 px-1.5 py-0.5 rounded text-slate-400">{{ c }}</span>
                        {% endfor %}
                    {% endif %}
                </div>
                
                <div class="mt-3 pt-2 border-t border-white/5 flex justify-between items-center">
                    <span class="text-[10px] text-slate-500 flex items-center gap-1">
                        <i data-lucide="clock" size="10"></i> {{ task.estimatedTime or '-' }}m
                    </span>
                    <button class="text-slate-600 hover:text-blue-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="edit-2" size="12"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
    document.querySelectorAll('.kanban-col').forEach(col => {
        new Sortable(col, {
            group: 'shared',
            animation: 150,
            ghostClass: 'opacity-50',
            onEnd: function (evt) {
                const taskId = evt.item.dataset.id;
                const newStatus = evt.to.dataset.status;
                
                fetch(`/api/tasks/${taskId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ status: newStatus })
                });
            }
        });
    });
</script>
{% endblock %}
